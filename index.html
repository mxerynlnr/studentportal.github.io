<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>QuestList â€” Student App</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Exo+2:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#07071a;--panel:#10102a;--card:#161636;--card2:#1c1c42;
  --border:#252550;--border2:#34346a;
  --purple:#6d28d9;--purple2:#a855f7;--purple3:#c084fc;
  --glow:rgba(109,40,217,.35);
  --gold:#f59e0b;--gold2:#fbbf24;--gold-glow:rgba(245,158,11,.35);
  --green:#10b981;--green2:#34d399;
  --red:#ef4444;--blue:#60a5fa;
  --text:#e8e6f0;--text2:#b0aec8;--muted:#6b6890;--muted2:#4a4870;
  --r-sm:8px;--r-md:13px;--r-lg:20px;--r-xl:26px;
  --t:.22s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg);color:var(--text);
  font-family:'Exo 2','Segoe UI',sans-serif;
  font-size:15px;min-height:100vh;overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}
button,input,textarea{font-family:inherit;}

/* STARFIELD */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 80% 40% at 50% -5%,rgba(109,40,217,.22),transparent),
    radial-gradient(1.5px 1.5px at 12% 22%,rgba(255,255,255,.55) 0%,transparent),
    radial-gradient(1px 1px at 82% 14%,rgba(255,255,255,.4) 0%,transparent),
    radial-gradient(1.5px 1.5px at 44% 68%,rgba(255,255,255,.6) 0%,transparent),
    radial-gradient(1px 1px at 90% 42%,rgba(255,255,255,.35) 0%,transparent),
    radial-gradient(1px 1px at 22% 78%,rgba(255,255,255,.45) 0%,transparent),
    radial-gradient(2px 2px at 34% 38%,rgba(167,139,250,.4) 0%,transparent),
    radial-gradient(2px 2px at 74% 62%,rgba(168,85,247,.3) 0%,transparent),
    radial-gradient(1.5px 1.5px at 67% 87%,rgba(255,255,255,.5) 0%,transparent),
    radial-gradient(1px 1px at 55% 12%,rgba(255,255,255,.3) 0%,transparent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{
  position:relative;z-index:1;
  max-width:520px;margin:0 auto;
  padding:16px 16px 90px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{text-align:center;padding:28px 0 14px;}
.header::after{
  content:'';display:block;height:1px;
  margin:16px auto 0;width:55%;
  background:linear-gradient(90deg,transparent,var(--border2),transparent);
}
.header h1{
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(1.4rem,5vw,2rem);font-weight:900;letter-spacing:.04em;
  background:linear-gradient(100deg,#c084fc,#a855f7,#fbbf24,#a855f7,#c084fc);
  background-size:300%;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:titleShimmer 6s linear infinite;
}
.tagline{color:var(--muted);font-size:.8rem;margin-top:6px;letter-spacing:.6px;}
@keyframes titleShimmer{0%{background-position:0%}100%{background-position:300%}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.player-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:var(--r-xl);padding:20px 22px;margin:14px 0;
  position:relative;overflow:hidden;
  box-shadow:0 0 40px rgba(109,40,217,.12),inset 0 1px 0 rgba(255,255,255,.04);
}
.player-card::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:radial-gradient(circle,rgba(109,40,217,.22),transparent 65%);pointer-events:none;}
.player-card::after{content:'';position:absolute;bottom:-50px;left:-50px;width:160px;height:160px;background:radial-gradient(circle,rgba(245,158,11,.1),transparent 65%);pointer-events:none;}

.player-top{display:flex;align-items:center;gap:16px;}
.avatar{
  position:relative;width:64px;height:64px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(145deg,#2e1065,#6d28d9,#a855f7);
  display:flex;align-items:center;justify-content:center;font-size:2.1rem;
  border:2px solid rgba(168,85,247,.55);
  box-shadow:0 0 22px var(--glow),inset 0 1px 0 rgba(255,255,255,.1);
  cursor:pointer;transition:transform var(--t),box-shadow var(--t);user-select:none;
}
.avatar:hover{transform:scale(1.09) rotate(-4deg);box-shadow:0 0 32px rgba(168,85,247,.65);}
.avatar-ring{
  position:absolute;inset:-5px;border-radius:50%;
  background:conic-gradient(#a855f7,#f59e0b,#34d399,#a855f7);
  -webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 3px),#fff calc(100% - 3px));
  mask:radial-gradient(farthest-side,transparent calc(100% - 3px),#fff calc(100% - 3px));
  animation:spinRing 5s linear infinite;opacity:.7;
}
@keyframes spinRing{to{transform:rotate(360deg);}}
.player-info{flex:1;min-width:0;}
.name-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.player-name{font-size:1.15rem;font-weight:800;color:#fff;letter-spacing:.02em;}
.level-badge{
  background:linear-gradient(90deg,var(--gold),#f97316);color:#1a0900;
  font-size:.68rem;font-weight:800;padding:3px 12px;border-radius:20px;
  letter-spacing:.07em;box-shadow:0 2px 10px var(--gold-glow);white-space:nowrap;
}
.player-title{font-size:.8rem;color:var(--purple3);margin-top:4px;font-weight:600;letter-spacing:.04em;}

/* XP BAR */
.xp-section{margin-top:18px;}
.xp-row{display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:7px;}
.xp-label{color:var(--purple3);font-weight:700;letter-spacing:.04em;}
.xp-nums{color:var(--muted);}
.xp-track{background:rgba(255,255,255,.06);border-radius:20px;height:13px;border:1px solid rgba(109,40,217,.25);overflow:hidden;}
.xp-fill{
  height:100%;border-radius:20px;
  background:linear-gradient(90deg,#4c1d95,#7c3aed,#c084fc);
  transition:width .75s cubic-bezier(.34,1.56,.64,1);
  position:relative;overflow:hidden;
}
.xp-fill::after{content:'';position:absolute;top:0;left:-60%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);animation:shimmer 2.4s infinite;}
@keyframes shimmer{0%{left:-60%}100%{left:130%}}
.xp-hint{font-size:.73rem;color:var(--muted);margin-top:6px;text-align:right;}

/* STATS */
.stats-row{display:flex;gap:8px;margin-top:16px;}
.stat-box{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 6px;text-align:center;transition:border-color var(--t);}
.stat-box:hover{border-color:rgba(109,40,217,.45);}
.stat-num{font-size:1.35rem;font-weight:800;color:#fff;line-height:1;}
.stat-lbl{font-size:.64rem;color:var(--muted);margin-top:4px;font-weight:600;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{
  display:flex;background:var(--panel);border:1px solid var(--border);
  border-radius:var(--r-md);padding:4px;gap:4px;margin:0 0 18px;
}
.tab{
  flex:1;text-align:center;padding:9px 4px;border-radius:9px;
  cursor:pointer;font-size:.79rem;font-weight:700;color:var(--muted);
  transition:all var(--t);user-select:none;letter-spacing:.02em;
}
.tab.active{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;box-shadow:0 2px 16px var(--glow);}
.tab:not(.active):hover{color:var(--text);background:rgba(255,255,255,.06);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{display:none;}
.panel.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION TITLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-title{
  font-family:'Cinzel Decorative',serif;font-size:.82rem;color:var(--purple3);
  letter-spacing:.1em;margin-bottom:14px;display:flex;align-items:center;gap:10px;
}
.sec-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border2),transparent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.task-list{display:flex;flex-direction:column;gap:10px;}
.task-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r-md);
  padding:14px 16px 14px 20px;
  display:flex;align-items:flex-start;gap:12px;
  position:relative;overflow:hidden;transition:opacity .35s,border-color var(--t);
}
.task-card:hover{border-color:var(--border2);}
.task-card.done{opacity:.5;}
.task-card.done .task-name{text-decoration:line-through;color:var(--muted);}
.task-card.done .task-name-done-note{display:inline;}
/* Colour stripe */
.task-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;}
.task-card.performance::before{background:linear-gradient(180deg,#a855f7,#6d28d9);}
.task-card.activity::before{background:linear-gradient(180deg,#60a5fa,#1d4ed8);}
/* Deadline urgency tint */
.task-card.deadline-warn{box-shadow:inset 0 0 0 1px rgba(245,158,11,.35);}
.task-card.deadline-late{box-shadow:inset 0 0 0 1px rgba(239,68,68,.4);}

/* Check button */
.check-btn{
  width:27px;height:27px;border-radius:50%;border:2px solid var(--border2);
  background:transparent;cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:.85rem;color:transparent;
  transition:all var(--t);
}
.check-btn:hover{border-color:var(--green);background:rgba(16,185,129,.12);transform:scale(1.12);}
.task-card.done .check-btn{background:var(--green);border-color:var(--green);color:#fff;}

.task-body{flex:1;min-width:0;}
.task-name{font-weight:700;font-size:.96rem;color:var(--text);word-break:break-word;line-height:1.35;}
.task-name-done-note{display:none;font-size:.72rem;color:var(--green2);font-weight:700;margin-left:6px;}
.task-meta{display:flex;gap:7px;margin-top:6px;align-items:center;flex-wrap:wrap;}
.type-tag{font-size:.65rem;font-weight:800;padding:2px 9px;border-radius:20px;text-transform:uppercase;}
.type-tag.performance{background:rgba(168,85,247,.2);color:#c084fc;}
.type-tag.activity{background:rgba(96,165,250,.2);color:#93c5fd;}
.xp-badge{font-size:.72rem;color:var(--gold2);font-weight:700;}

/* Deadline badge */
.dl-badge{font-size:.68rem;font-weight:700;padding:2px 8px;border-radius:20px;}
.dl-ok{background:rgba(16,185,129,.15);color:var(--green2);}
.dl-warn{background:rgba(245,158,11,.18);color:var(--gold2);}
.dl-late{background:rgba(239,68,68,.15);color:#fca5a5;}

/* Task notes */
.task-notes-box{
  margin-top:7px;font-size:.79rem;color:var(--text2);line-height:1.55;
  padding:8px 10px;background:rgba(255,255,255,.04);border-radius:7px;
  border-left:3px solid var(--border2);
}

/* Task file attachments */
.task-attach{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.attach-btn{
  display:inline-flex;align-items:center;gap:5px;
  font-size:.73rem;font-weight:600;color:var(--purple3);
  background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.25);
  border-radius:7px;padding:3px 9px;cursor:pointer;transition:all var(--t);
}
.attach-btn:hover{background:rgba(168,85,247,.2);border-color:var(--purple2);}

/* Subject tag */
.subject-tag{font-size:.68rem;color:var(--muted);font-style:italic;}

/* Approved badge */
.approved-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.68rem;font-weight:800;padding:2px 8px;border-radius:20px;
  background:rgba(16,185,129,.15);color:var(--green2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);}
.empty-icon{font-size:3.5rem;display:block;margin-bottom:14px;opacity:.3;}
.empty-title{font-family:'Cinzel Decorative',serif;font-size:.82rem;color:var(--muted);margin-bottom:6px;letter-spacing:.07em;}
.empty-sub{font-size:.82rem;line-height:1.65;}
.empty-sub strong{color:var(--purple3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;gap:7px;border:none;border-radius:var(--r-sm);
  padding:11px 20px;font-weight:700;font-size:.9rem;
  transition:all var(--t);white-space:nowrap;cursor:pointer;
}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:none;}
.btn-purple{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;}
.btn-purple:hover{box-shadow:0 6px 20px var(--glow);}
.btn-gold{background:linear-gradient(135deg,var(--gold),#f97316);color:#1a0900;}
.btn-gold:hover{box-shadow:0 6px 20px var(--gold-glow);}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.btn-ghost:hover{border-color:var(--purple3);color:var(--purple3);box-shadow:none;transform:none;}
.btn-green{background:linear-gradient(135deg,#065f46,var(--green));color:#fff;}
.btn-perf{background:linear-gradient(135deg,#4c1d95,var(--purple2));color:#fff;flex:1;justify-content:center;flex-direction:column;gap:3px;padding:14px;text-align:center;}
.btn-perf small,.btn-act small{font-weight:800;color:var(--gold2);font-size:.78rem;display:block;}
.btn-act{background:linear-gradient(135deg,#1e3a8a,#3b82f6);color:#fff;flex:1;justify-content:center;flex-direction:column;gap:3px;padding:14px;text-align:center;}
.btn-full{width:100%;justify-content:center;}
.btn-sm{padding:7px 14px;font-size:.78rem;border-radius:8px;}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;}
.type-btns{display:flex;gap:12px;margin-bottom:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ARCHIVE TOGGLE (done tasks tab)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-row{
  display:flex;gap:8px;margin-bottom:16px;
  background:var(--panel);padding:4px;border-radius:var(--r-md);
}
.filter-btn{
  flex:1;padding:7px;border-radius:9px;border:none;
  font-size:.79rem;font-weight:700;cursor:pointer;
  transition:all var(--t);background:transparent;color:var(--muted);
}
.filter-btn.active{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;box-shadow:0 2px 12px var(--glow);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR SCANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.qr-card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--r-xl);
  padding:22px;position:relative;overflow:hidden;
}
.qr-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--purple2),transparent);}
.info-banner{
  display:flex;gap:12px;align-items:flex-start;
  background:rgba(109,40,217,.1);border:1px solid rgba(109,40,217,.28);
  border-radius:var(--r-sm);padding:11px 14px;
  font-size:.82rem;color:var(--text2);line-height:1.55;margin-bottom:18px;
}
#video-wrap{display:none;border-radius:var(--r-md);overflow:hidden;background:#000;position:relative;margin-top:14px;border:1px solid var(--border2);}
#qr-video{width:100%;display:block;}
#qr-canvas{display:none;}
.scan-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.scan-frame{width:200px;height:200px;border:2px solid var(--purple2);border-radius:16px;box-shadow:0 0 0 9999px rgba(0,0,0,.52);position:relative;}
.corner{position:absolute;width:22px;height:22px;border-color:var(--purple3);border-style:solid;}
.tl{top:-2px;left:-2px;border-width:3px 0 0 3px;border-radius:5px 0 0 0;}
.tr{top:-2px;right:-2px;border-width:3px 3px 0 0;border-radius:0 5px 0 0;}
.bl{bottom:-2px;left:-2px;border-width:0 0 3px 3px;border-radius:0 0 0 5px;}
.br{bottom:-2px;right:-2px;border-width:0 3px 3px 0;border-radius:0 0 5px 0;}
.scan-beam{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--purple3),transparent);animation:scanBeam 2s ease-in-out infinite;}
@keyframes scanBeam{0%,100%{top:4%}50%{top:92%}}
.qr-result{display:none;margin-top:16px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.3);border-radius:var(--r-md);padding:16px;animation:fadeUp .3s ease;}
.qr-result.show{display:block;}
.qr-result-label{font-weight:800;font-size:.74rem;color:var(--green2);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
.qr-result-text{color:#fff;word-break:break-all;font-size:.9rem;font-weight:600;padding:9px 11px;background:rgba(255,255,255,.05);border-radius:8px;border:1px solid var(--border);margin-bottom:8px;}
.qr-result-note{font-size:.79rem;color:var(--muted);margin-bottom:12px;}
.xp-legend{margin-top:18px;padding-top:16px;border-top:1px solid var(--border);}
.xp-legend h4{font-weight:700;font-size:.8rem;color:var(--text2);margin-bottom:10px;}
.xp-legend-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.xp-tag{font-size:.73rem;font-weight:800;padding:3px 10px;border-radius:20px;text-transform:uppercase;}
.xp-tag.performance{background:rgba(168,85,247,.18);color:#c084fc;}
.xp-tag.activity{background:rgba(96,165,250,.18);color:#93c5fd;}
.xp-val{font-size:.8rem;font-weight:800;color:var(--gold2);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REWARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rewards-intro{
  background:linear-gradient(135deg,rgba(245,158,11,.07),rgba(109,40,217,.07));
  border:1px solid rgba(245,158,11,.2);border-radius:var(--r-md);
  padding:14px 16px;font-size:.84rem;color:var(--text2);line-height:1.65;
  margin-bottom:20px;text-align:center;
}
.rewards-intro strong{color:var(--gold2);}
.earned-reward{
  background:var(--card);border:1px solid rgba(245,158,11,.4);
  border-radius:var(--r-md);padding:14px 16px;
  display:flex;align-items:center;gap:14px;margin-bottom:10px;
  background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(251,191,36,.03));
  box-shadow:0 0 20px rgba(245,158,11,.08);animation:fadeUp .4s ease;
}
.earned-reward-icon{font-size:2.2rem;width:50px;text-align:center;flex-shrink:0;}
.earned-reward-info{flex:1;min-width:0;}
.earned-reward-name{font-weight:700;color:#fff;font-size:.95rem;}
.earned-reward-sub{font-size:.76rem;color:var(--muted);margin-top:3px;}
.earned-reward-badge{font-size:.7rem;font-weight:800;padding:3px 12px;border-radius:20px;background:rgba(245,158,11,.2);color:var(--gold2);white-space:nowrap;}
.no-rewards{text-align:center;padding:36px 20px;color:var(--muted);font-size:.84rem;line-height:1.6;}
.no-rewards span{font-size:2.5rem;display:block;margin-bottom:10px;opacity:.3;}
.roadmap-row{display:flex;align-items:center;gap:12px;border-radius:10px;padding:9px 13px;margin-bottom:8px;font-size:.82rem;}
.roadmap-row.done{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.22);}
.roadmap-row.current{background:rgba(109,40,217,.1);border:1px solid rgba(109,40,217,.35);box-shadow:0 0 12px var(--glow);}
.roadmap-row.future{background:rgba(255,255,255,.03);border:1px solid var(--border);opacity:.5;}
.roadmap-icon{font-size:1.1rem;width:24px;text-align:center;flex-shrink:0;}
.roadmap-level{font-weight:800;min-width:58px;}
.roadmap-row.done .roadmap-level{color:var(--gold2);}
.roadmap-row.current .roadmap-level{color:var(--purple3);}
.roadmap-row.future .roadmap-level{color:var(--muted);}
.roadmap-xp{flex:1;color:var(--muted);}
.roadmap-status{font-size:.7rem;font-weight:800;}
.roadmap-row.done .roadmap-status{color:var(--green2);}
.roadmap-row.current .roadmap-status{color:var(--purple3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(5,5,20,.85);backdrop-filter:blur(8px);z-index:500;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--panel);border:1px solid var(--border2);border-radius:var(--r-xl);
  padding:30px 26px;max-width:420px;width:100%;text-align:center;
  position:relative;overflow:hidden;
  animation:popIn .4s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 24px 60px rgba(0,0,0,.6),0 0 40px var(--glow);
}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--purple2),transparent);}
@keyframes popIn{from{transform:scale(.6) translateY(24px);opacity:0;}to{transform:scale(1) translateY(0);opacity:1;}}
.modal-emoji{font-size:3.8rem;display:block;margin-bottom:12px;}
.modal-title{font-family:'Cinzel Decorative',serif;font-size:1.3rem;font-weight:900;margin-bottom:10px;color:#fff;letter-spacing:.04em;}
.gradient-text{background:linear-gradient(90deg,var(--purple3),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.modal-body{color:var(--text2);font-size:.9rem;line-height:1.7;margin-bottom:18px;}
.modal-body strong{color:#fff;}
.modal-input{
  width:100%;background:var(--card);border:1px solid var(--border2);border-radius:var(--r-sm);
  color:#fff;font-size:.98rem;font-weight:600;padding:11px 14px;outline:none;margin-bottom:14px;
  transition:border-color var(--t);
}
.modal-input:focus{border-color:var(--purple2);box-shadow:0 0 0 3px rgba(168,85,247,.2);}
.modal-input::placeholder{color:var(--muted);}
.highlight-text{color:var(--purple3);word-break:break-word;display:block;margin-top:4px;}

/* Reward picker */
.reward-picker{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;text-align:left;}
.reward-option{background:var(--card);border:2px solid var(--border);border-radius:var(--r-sm);padding:12px;cursor:pointer;transition:all var(--t);position:relative;}
.reward-option:hover{border-color:var(--purple2);transform:translateY(-2px);}
.reward-option.selected{border-color:var(--gold2);background:rgba(245,158,11,.1);box-shadow:0 0 16px rgba(245,158,11,.2);}
.reward-option-icon{font-size:1.9rem;display:block;margin-bottom:5px;}
.reward-option-name{font-size:.78rem;font-weight:800;color:#fff;line-height:1.3;}
.reward-option-desc{font-size:.68rem;color:var(--muted);margin-top:2px;}
.reward-check{position:absolute;top:6px;right:6px;width:18px;height:18px;background:var(--gold2);border-radius:50%;display:none;align-items:center;justify-content:center;font-size:.62rem;color:#000;font-weight:900;}
.reward-option.selected .reward-check{display:flex;}

/* File view modal */
.file-view-modal{max-width:85vw;max-height:88vh;overflow:auto;padding:16px;text-align:left;}
.file-view-modal img{max-width:100%;border-radius:10px;display:block;}
.modal-close-btn{position:absolute;top:12px;right:14px;background:rgba(255,255,255,.08);border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;color:#fff;font-size:.9rem;display:flex;align-items:center;justify-content:center;transition:background var(--t);}
.modal-close-btn:hover{background:rgba(239,68,68,.3);}

/* QR task details modal */
.qr-task-details{margin:-4px 0 14px;text-align:left;}
.qr-task-details .notes-box{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:.83rem;color:var(--text2);line-height:1.55;margin-bottom:10px;}
.qr-task-img{max-width:100%;border-radius:10px;border:1px solid var(--border);max-height:200px;object-fit:contain;cursor:pointer;margin-bottom:10px;display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI & XP FLOAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#confetti-wrap{position:fixed;inset:0;pointer-events:none;z-index:999;overflow:hidden;}
.cp{position:absolute;top:-5%;animation:cpFall linear forwards;border-radius:3px;}
@keyframes cpFall{0%{opacity:1;transform:rotate(0deg) translateX(0);}100%{top:110%;opacity:0;transform:rotate(720deg) translateX(70px);}}
.xp-float{position:fixed;pointer-events:none;z-index:998;font-family:'Exo 2',sans-serif;font-weight:800;font-size:1.4rem;color:var(--gold2);text-shadow:0 0 14px var(--gold-glow);animation:xpUp 1.5s ease-out forwards;}
@keyframes xpUp{0%{opacity:1;transform:translateY(0) scale(1);}40%{opacity:1;transform:translateY(-40px) scale(1.15);}100%{opacity:0;transform:translateY(-100px) scale(.8);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;bottom:28px;left:50%;
  transform:translateX(-50%) translateY(90px);
  background:var(--card2);border:1px solid var(--border2);
  border-radius:14px;padding:12px 24px;font-size:.88rem;font-weight:700;color:#fff;
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);z-index:800;white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:calc(100vw - 40px);overflow:hidden;text-overflow:ellipsis;
}
#toast.show{transform:translateX(-50%) translateY(0);}
#toast.ok{background:#065f46;}
#toast.err{background:#991b1b;}

@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}
.mt-md{margin-top:20px;}
</style>
</head>
<body>
<div id="confetti-wrap"></div>
<div id="toast"></div>

<!-- â•â• NAME MODAL â•â• -->
<div class="modal-overlay open" id="modal-name">
  <div class="modal">
    <span class="modal-emoji">ğŸ§™</span>
    <h2 class="modal-title gradient-text">Welcome!</h2>
    <p class="modal-body">Enter your name to begin your quest.<br/>Complete tasks from your teacher, earn XP, level up and choose your own rewards!</p>
    <input class="modal-input" id="input-name" type="text" placeholder="Your nameâ€¦" maxlength="28" onkeydown="if(event.key==='Enter') saveName()"/>
    <button class="btn btn-purple btn-full" onclick="saveName()">âœ¨ Begin Quest</button>
  </div>
</div>

<!-- â•â• LEVEL UP / REWARD MODAL â•â• -->
<div class="modal-overlay" id="modal-reward">
  <div class="modal">
    <span class="modal-emoji">ğŸ‰</span>
    <h2 class="modal-title gradient-text">LEVEL UP!</h2>
    <p class="modal-body">You reached <strong id="reward-level-txt"></strong>!<br/>Choose your reward â€” you earned it!</p>
    <div class="reward-picker" id="reward-picker-grid"></div>
    <button class="btn btn-gold btn-full" id="btn-claim" disabled onclick="claimReward()">ğŸ† Claim Reward</button>
  </div>
</div>

<!-- â•â• QR TASK CONFIRM MODAL â•â• -->
<div class="modal-overlay" id="modal-qr-confirm">
  <div class="modal" style="max-width:440px;">
    <button class="modal-close-btn" onclick="closeModal('modal-qr-confirm')">âœ•</button>
    <span class="modal-emoji">ğŸ“‹</span>
    <h2 class="modal-title" style="color:#fff;font-size:1.05rem;">New Task Received!</h2>
    <p class="modal-body" style="margin-bottom:10px;">Task from your teacher:<br/><strong id="qr-confirm-title" class="highlight-text"></strong></p>
    <div class="qr-task-details" id="qr-task-details"></div>
    <p class="modal-body" style="font-size:.84rem;margin-bottom:10px;">What type of task is this?</p>
    <div class="type-btns">
      <button class="btn btn-perf" onclick="addScannedTask('performance')">âš¡ Performance Task<small>+50 XP</small></button>
      <button class="btn btn-act"  onclick="addScannedTask('activity')">ğŸ“ Activity<small>+25 XP</small></button>
    </div>
    <button class="btn btn-ghost btn-full" style="margin-top:8px;" onclick="closeModal('modal-qr-confirm')">Cancel</button>
  </div>
</div>

<!-- â•â• FILE VIEW MODAL â•â• -->
<div class="modal-overlay" id="modal-file">
  <div class="modal file-view-modal">
    <button class="modal-close-btn" onclick="closeModal('modal-file')">âœ•</button>
    <div id="file-modal-content"></div>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div class="app">

  <header class="header">
    <h1>âš”ï¸ QuestList</h1>
    <p class="tagline">classroom edition Â· earn xp Â· level up Â· choose rewards</p>
  </header>

  <!-- PLAYER CARD -->
  <section class="player-card">
    <div class="player-top">
      <div class="avatar" onclick="openNameModal()" title="Tap to change name">
        <div class="avatar-ring"></div>ğŸ§™
      </div>
      <div class="player-info">
        <div class="name-row">
          <span class="player-name" id="player-name">Adventurer</span>
          <span class="level-badge" id="level-badge">LVL 0</span>
        </div>
        <div class="player-title" id="player-title">Novice Scholar</div>
      </div>
    </div>
    <div class="xp-section">
      <div class="xp-row">
        <span class="xp-label">âš¡ XP Progress</span>
        <span class="xp-nums" id="xp-nums">0 / 50 XP</span>
      </div>
      <div class="xp-track"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
      <div class="xp-hint" id="xp-hint">50 XP to reach Level 1</div>
    </div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-num" id="stat-active">0</div><div class="stat-lbl">ğŸ“‹ Active</div></div>
      <div class="stat-box"><div class="stat-num" id="stat-done">0</div><div class="stat-lbl">âœ… Done</div></div>
      <div class="stat-box"><div class="stat-num" id="stat-xp">0</div><div class="stat-lbl">âš¡ Total XP</div></div>
      <div class="stat-box"><div class="stat-num" id="stat-rw">0</div><div class="stat-lbl">ğŸ† Rewards</div></div>
    </div>
  </section>

  <!-- TABS â€” 4 tabs -->
  <nav class="tabs">
    <div class="tab active" onclick="switchTab('tasks',this)">ğŸ“‹ Tasks</div>
    <div class="tab" onclick="switchTab('done',this)">âœ… Done</div>
    <div class="tab" onclick="switchTab('scanner',this)">ğŸ“· Scan</div>
    <div class="tab" onclick="switchTab('rewards',this)">ğŸ† Rewards</div>
  </nav>

  <!-- â”€â”€ TASKS PANEL â”€â”€ -->
  <section class="panel active" id="panel-tasks">
    <h3 class="sec-title">âš”ï¸ Active Quests</h3>
    <div class="empty-state" id="empty-tasks">
      <span class="empty-icon">ğŸ—ºï¸</span>
      <p class="empty-title">No Active Quests</p>
      <p class="empty-sub">Your teacher will assign tasks via QR code.<br/>Go to <strong>ğŸ“· Scan</strong> tab to get your first quest!</p>
    </div>
    <div class="task-list" id="task-list-active"></div>
  </section>

  <!-- â”€â”€ DONE PANEL â”€â”€ -->
  <section class="panel" id="panel-done">
    <h3 class="sec-title">âœ… Completed Quests</h3>
    <div class="empty-state" id="empty-done">
      <span class="empty-icon">ğŸ…</span>
      <p class="empty-title">Nothing Completed Yet</p>
      <p class="empty-sub">Complete tasks to see them here and earn XP!</p>
    </div>
    <div class="task-list" id="task-list-done"></div>
  </section>

  <!-- â”€â”€ SCANNER PANEL â”€â”€ -->
  <section class="panel" id="panel-scanner">
    <div class="qr-card">
      <h3 class="sec-title">ğŸ“· Scan Teacher QR</h3>
      <div class="info-banner">
        <span style="font-size:1.3rem;flex-shrink:0;">ğŸ§‘â€ğŸ«</span>
        <span>Your teacher will show a QR code for each task. Scan it here to add it to your quest list and start earning XP!</span>
      </div>
      <div class="btn-row">
        <button class="btn btn-purple" id="btn-start" onclick="startScan()">ğŸ“· Start Camera</button>
        <button class="btn btn-ghost" id="btn-stop" onclick="stopScan()" style="display:none">â¹ Stop</button>
      </div>
      <div id="video-wrap">
        <video id="qr-video" autoplay playsinline muted></video>
        <div class="scan-overlay">
          <div class="scan-frame">
            <span class="corner tl"></span><span class="corner tr"></span>
            <span class="corner bl"></span><span class="corner br"></span>
            <div class="scan-beam"></div>
          </div>
        </div>
      </div>
      <canvas id="qr-canvas"></canvas>
      <div class="qr-result" id="qr-result">
        <p class="qr-result-label">âœ… QR Detected!</p>
        <p class="qr-result-text" id="qr-result-text"></p>
        <p class="qr-result-note">Is this the correct task from your teacher?</p>
        <div class="btn-row">
          <button class="btn btn-green btn-sm" onclick="acceptScan()">âœ… Yes, Add Quest</button>
          <button class="btn btn-ghost btn-sm" onclick="rejectScan()">ğŸ”„ Scan Again</button>
        </div>
      </div>
      <div class="xp-legend">
        <h4>âš¡ XP Values</h4>
        <div class="xp-legend-row"><span class="xp-tag performance">âš¡ Performance Task</span><span class="xp-val">+50 XP</span></div>
        <div class="xp-legend-row"><span class="xp-tag activity">ğŸ“ Activity</span><span class="xp-val">+25 XP</span></div>
      </div>

      <!-- Manual QR code entry fallback -->
      <div id="manual-entry-section" style="margin-top:20px;padding-top:18px;border-top:1px solid var(--border);">
        <h4 style="font-size:.8rem;font-weight:700;color:var(--text2);margin-bottom:10px;letter-spacing:.04em;">ğŸ“‹ Manual Entry (if camera unavailable)</h4>
        <p style="font-size:.76rem;color:var(--muted);margin-bottom:10px;line-height:1.55;">Ask your teacher for the QR code text and paste it here:</p>
        <div style="display:flex;gap:8px;">
          <input
            id="manual-qr-input"
            type="text"
            placeholder="Paste QR code text hereâ€¦"
            style="flex:1;background:var(--card);border:1px solid var(--border2);border-radius:var(--r-sm);color:#fff;font-size:.85rem;padding:9px 12px;outline:none;transition:border-color var(--t);"
            onfocus="this.style.borderColor='var(--purple2)'"
            onblur="this.style.borderColor='var(--border2)'"
            onkeydown="if(event.key==='Enter') submitManualQR()"
          />
          <button class="btn btn-green btn-sm" onclick="submitManualQR()">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- â”€â”€ REWARDS PANEL â”€â”€ -->
  <section class="panel" id="panel-rewards">
    <div class="rewards-intro">
      Every time you <strong>level up</strong>, pick <strong>one reward</strong> from a selection!<br/>
      Show your teacher to claim it. ğŸ‰
    </div>
    <h3 class="sec-title">ğŸ† Earned Rewards</h3>
    <div id="rewards-list"></div>
    <h3 class="sec-title mt-md">ğŸ“Š XP Roadmap</h3>
    <div id="xp-roadmap"></div>
  </section>

</div><!-- /.app -->

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATE_KEY = 'ql_student_v2';
const SCAN_KEY  = 'ql_student_scans_v1'; // shared with teacher portal
const XP_MAP    = {performance:50, activity:25};
const TITLES    = ['Novice Scholar','Apprentice','Knowledge Seeker','Task Warrior','Rising Champion','Quest Master','Bronze Achiever','Silver Scholar','Gold Performer','Platinum Hero','Diamond Legend','Grandmaster'];
function xpToAdvance(lv){ return (lv+1)*50; }
function getTitle(lv){ return TITLES[Math.min(lv,TITLES.length-1)]; }

const REWARD_POOL = [
  {id:'r01',icon:'ğŸ®',name:'Free Game Time',   desc:'15 min of free game time'},
  {id:'r02',icon:'ğŸ«',name:'Snack Pass',        desc:'One snack of your choice'},
  {id:'r03',icon:'ğŸ“š',name:'Free Reading',      desc:'10 min free reading time'},
  {id:'r04',icon:'ğŸµ',name:'Music Pass',        desc:'Listen to music while working'},
  {id:'r05',icon:'â­',name:'Gold Star',         desc:'A gold star on the class board'},
  {id:'r06',icon:'ğŸ’º',name:'Seat Choice',       desc:'Pick your seat for the day'},
  {id:'r07',icon:'ğŸ“–',name:'Skip Homework',     desc:'Skip one homework assignment'},
  {id:'r08',icon:'ğŸ¨',name:'Art Break',         desc:'10 min free drawing time'},
  {id:'r09',icon:'ğŸ…',name:'Helper Badge',      desc:'Be the class helper today'},
  {id:'r10',icon:'ğŸ•¹ï¸',name:'Extra Recess',      desc:'5 extra minutes of recess'},
  {id:'r11',icon:'ğŸ“',name:'Sticker Pack',      desc:'Choose a sticker pack'},
  {id:'r12',icon:'ğŸ§©',name:'Puzzle Time',       desc:'10 min brain game'},
  {id:'r13',icon:'ğŸ“¢',name:'Line Leader',       desc:'Lead the class line today'},
  {id:'r14',icon:'ğŸŒŸ',name:'Star Certificate',  desc:'Certificate of excellence'},
  {id:'r15',icon:'ğŸ¤',name:'Show & Tell',       desc:'Bring one item for show & tell'},
  {id:'r16',icon:'ğŸ†',name:'Trophy Display',    desc:'Your name on the trophy board'},
];

const CP_COLORS=['#a78bfa','#f472b6','#fbbf24','#34d399','#60a5fa','#fb923c','#f87171'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let state = (()=>{
  try{ const r=JSON.parse(localStorage.getItem(STATE_KEY)); if(r) return r; }catch(_){}
  return {name:'',level:0,currentXP:0,totalXP:0,tasks:[],nextId:1,earnedRewards:[],pendingReward:false};
})();
function save(){ try{localStorage.setItem(STATE_KEY,JSON.stringify(state));}catch(_){} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
let _tt=null;
function toast(msg,type='',dur=2800){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className='show'+(type?' '+type:'');
  clearTimeout(_tt); _tt=setTimeout(()=>el.className='',dur);
}
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function spawnConfetti(){
  const w=document.getElementById('confetti-wrap'); w.innerHTML='';
  for(let i=0;i<80;i++){
    const p=document.createElement('div'); p.className='cp';
    const s=6+Math.random()*9;
    p.style.cssText=`left:${Math.random()*100}%;width:${s}px;height:${s+Math.random()*7}px;background:${CP_COLORS[i%CP_COLORS.length]};animation-duration:${1.5+Math.random()*2.5}s;animation-delay:${Math.random()*.7}s;border-radius:${Math.random()>.5?'50%':'3px'};`;
    w.appendChild(p);
  }
  setTimeout(()=>w.innerHTML='',5500);
}
function spawnXpFloat(text,el){
  const r=el?el.getBoundingClientRect():{left:window.innerWidth/2-30,top:window.innerHeight/2,width:0};
  const f=document.createElement('div'); f.className='xp-float';
  f.textContent=text;
  f.style.left=(r.left+r.width/2-30)+'px'; f.style.top=(r.top+window.scrollY-10)+'px';
  document.body.appendChild(f); setTimeout(()=>f.remove(),1600);
}

/* Deadline helpers */
function deadlineClass(dl){
  if(!dl) return '';
  const diff=new Date(dl)-new Date();
  if(diff<0) return 'deadline-late';
  if(diff<86400000) return 'deadline-warn';
  return '';
}
function deadlineBadge(dl){
  if(!dl) return '';
  const diff=new Date(dl)-new Date();
  if(diff<0) return `<span class="dl-badge dl-late">âš  Past due</span>`;
  const h=diff/3600000;
  if(h<24) return `<span class="dl-badge dl-warn">â° ${Math.round(h)}h left</span>`;
  const d=Math.ceil(diff/86400000);
  return `<span class="dl-badge dl-ok">ğŸ“… ${d}d left</span>`;
}
function fmtDeadline(dl){
  if(!dl) return '';
  return new Date(dl).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  renderPlayer();
  renderTasks();
  renderRewards();
}

function renderPlayer(){
  document.getElementById('player-name').textContent  = state.name||'Adventurer';
  document.getElementById('level-badge').textContent  = 'LVL '+state.level;
  document.getElementById('player-title').textContent = getTitle(state.level);
  const need=xpToAdvance(state.level);
  const pct =Math.min(100,Math.round(state.currentXP/need*100));
  document.getElementById('xp-fill').style.width = pct+'%';
  document.getElementById('xp-nums').textContent  = state.currentXP+' / '+need+' XP';
  document.getElementById('xp-hint').textContent  = (need-state.currentXP)+' XP to reach Level '+(state.level+1);
  const active=state.tasks.filter(t=>!t.done).length;
  const done  =state.tasks.filter(t=>t.done).length;
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-done').textContent   = done;
  document.getElementById('stat-xp').textContent     = state.totalXP;
  document.getElementById('stat-rw').textContent     = state.earnedRewards.length;
}

function renderTasks(){
  const active=state.tasks.filter(t=>!t.done);
  const done  =state.tasks.filter(t=>t.done);
  // Active
  const al=document.getElementById('task-list-active');
  const ae=document.getElementById('empty-tasks');
  al.innerHTML=''; ae.style.display=active.length?'none':'block';
  active.forEach(t=>{ const el=buildTaskCard(t); al.appendChild(el); });
  // Done
  const dl=document.getElementById('task-list-done');
  const de=document.getElementById('empty-done');
  dl.innerHTML=''; de.style.display=done.length?'none':'block';
  [...done].reverse().forEach(t=>{ const el=buildTaskCard(t); dl.appendChild(el); });
}

function buildTaskCard(task){
  const scans=loadScans();
  const myScan=scans.find(s=>s.taskId===task.sourceTaskId&&s.studentName===state.name);
  const isApproved=myScan&&myScan.approved;
  const dlClass=deadlineClass(task.deadline);
  const div=document.createElement('div');
  div.className=`task-card ${task.type}${task.done?' done':''}${dlClass?' '+dlClass:''}`;
  div.dataset.id=task.id;
  // Build file attachments html
  let filesHtml='';
  if(task.files&&task.files.length){
    filesHtml=`<div class="task-attach">${task.files.map((f,i)=>`<span class="attach-btn" onclick="viewTaskFile(${task.id},${i})">${fileIcon(f.type)} ${esc(f.name)}</span>`).join('')}</div>`;
  }
  div.innerHTML=`
    <div class="check-btn" data-id="${task.id}">${task.done?'âœ“':''}</div>
    <div class="task-body">
      <div class="task-name">${esc(task.name)}<span class="task-name-done-note">âœ“</span></div>
      ${task.subject?`<span class="subject-tag">ğŸ“š ${esc(task.subject)}</span>`:''}
      <div class="task-meta">
        <span class="type-tag ${task.type}">${task.type==='performance'?'âš¡ Performance':'ğŸ“ Activity'}</span>
        <span class="xp-badge">${task.done?'':'+'+ XP_MAP[task.type]+' XP'}</span>
        ${deadlineBadge(task.deadline)}
        ${isApproved?'<span class="approved-badge">âœ… Teacher Approved</span>':''}
      </div>
      ${task.notes?`<div class="task-notes-box">${esc(task.notes)}</div>`:''}
      ${task.deadline?`<div style="font-size:.73rem;color:var(--muted);margin-top:4px;">â° Due: ${fmtDeadline(task.deadline)}</div>`:''}
      ${filesHtml}
    </div>`;
  return div;
}

function fileIcon(type){
  if(!type) return 'ğŸ“';
  if(type==='application/pdf') return 'ğŸ“„';
  if(type.includes('word')||type.includes('docx')) return 'ğŸ“';
  if(type.startsWith('image/')) return 'ğŸ–¼ï¸';
  return 'ğŸ“';
}

function viewTaskFile(taskId,fileIdx){
  const task=state.tasks.find(t=>t.id===taskId);
  if(!task||!task.files) return;
  const file=task.files[fileIdx];
  if(!file) return;
  const wrap=document.getElementById('file-modal-content');
  if(file.type&&file.type.startsWith('image/')){
    wrap.innerHTML=`<h3 style="margin-bottom:12px;color:var(--purple3);font-family:'Cinzel Decorative',serif;font-size:.9rem;">${esc(file.name)}</h3><img src="${file.dataUrl}" alt="${esc(file.name)}"/>`;
  } else if(file.type==='application/pdf'){
    wrap.innerHTML=`<h3 style="margin-bottom:12px;color:var(--purple3);">${esc(file.name)}</h3><iframe src="${file.dataUrl}" style="width:100%;height:65vh;border:none;border-radius:10px;"></iframe>`;
  } else {
    wrap.innerHTML=`<h3 style="margin-bottom:12px;color:var(--purple3);">${esc(file.name)}</h3><div style="text-align:center;padding:30px;"><div style="font-size:3.5rem;margin-bottom:12px;">ğŸ“„</div><p style="color:var(--muted);margin-bottom:16px;">Preview unavailable for this file type.</p><a href="${file.dataUrl}" download="${esc(file.name)}" class="btn btn-purple">â¬‡ Download</a></div>`;
  }
  document.getElementById('modal-file').classList.add('open');
}

function renderRewards(){
  // Earned list
  const rl=document.getElementById('rewards-list');
  rl.innerHTML='';
  if(!state.earnedRewards.length){
    rl.innerHTML='<div class="no-rewards"><span>ğŸ†</span>No rewards yet â€” complete tasks to level up!</div>';
  } else {
    [...state.earnedRewards].reverse().forEach(e=>{
      const rw=REWARD_POOL.find(r=>r.id===e.rewardId); if(!rw) return;
      const d=document.createElement('div'); d.className='earned-reward';
      d.innerHTML=`<div class="earned-reward-icon">${rw.icon}</div><div class="earned-reward-info"><div class="earned-reward-name">${rw.name}</div><div class="earned-reward-sub">Earned at Level ${e.level} Â· ${rw.desc}</div></div><span class="earned-reward-badge">âœ… LVL ${e.level}</span>`;
      rl.appendChild(d);
    });
  }
  // Roadmap
  const rm=document.getElementById('xp-roadmap'); rm.innerHTML='';
  for(let lv=0;lv<=Math.max(9,state.level+3);lv++){
    const need=xpToAdvance(lv);
    const cls =state.level>lv?'done':state.level===lv?'current':'future';
    const icon=cls==='done'?'âœ…':cls==='current'?'âš¡':'ğŸ”’';
    const status=cls==='done'?'DONE':cls==='current'?'IN PROGRESS':'';
    const d=document.createElement('div'); d.className='roadmap-row '+cls;
    d.innerHTML=`<span class="roadmap-icon">${icon}</span><span class="roadmap-level">Level ${lv}</span><span class="roadmap-xp">${need} XP to advance</span><span class="roadmap-status">${status}</span>`;
    rm.appendChild(d);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK COMPLETION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('click',e=>{
  const cb=e.target.closest('.check-btn');
  if(cb&&cb.dataset.id){
    const id=parseInt(cb.dataset.id);
    const task=state.tasks.find(t=>t.id===id);
    if(!task||task.done) return;
    task.done=true;
    const gain=XP_MAP[task.type];
    state.currentXP+=gain; state.totalXP+=gain;
    spawnXpFloat('+'+gain+' XP âš¡',cb);
    checkLevelUp(); save(); render();
    toast('âœ… Quest done! +'+gain+' XP!','ok');
  }
});

function checkLevelUp(){
  const need=xpToAdvance(state.level);
  if(state.currentXP>=need){
    state.currentXP-=need; state.level++;
    state.pendingReward=true;
    save(); spawnConfetti();
    setTimeout(openRewardModal,600);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openNameModal(){
  document.getElementById('input-name').value=state.name||'';
  document.getElementById('modal-name').classList.add('open');
  setTimeout(()=>document.getElementById('input-name').focus(),120);
}
function saveName(){
  const v=document.getElementById('input-name').value.trim();
  if(v){state.name=v;save();render();}
  closeModal('modal-name');
}

let _rOpts=[],_rSel=null;
function openRewardModal(){
  const claimed=state.earnedRewards.map(r=>r.rewardId);
  const pool=REWARD_POOL.filter(r=>!claimed.includes(r.id));
  _rOpts=[...(pool.length>=4?pool:REWARD_POOL)].sort(()=>Math.random()-.5).slice(0,4);
  _rSel=null;
  document.getElementById('reward-level-txt').textContent='Level '+state.level+'!';
  const grid=document.getElementById('reward-picker-grid'); grid.innerHTML='';
  _rOpts.forEach(rw=>{
    const d=document.createElement('div'); d.className='reward-option'; d.dataset.rid=rw.id;
    d.innerHTML=`<span class="reward-option-icon">${rw.icon}</span><div class="reward-option-name">${rw.name}</div><div class="reward-option-desc">${rw.desc}</div><div class="reward-check">âœ“</div>`;
    d.addEventListener('click',()=>{ _rSel=rw.id; document.querySelectorAll('.reward-option').forEach(el=>el.classList.toggle('selected',el.dataset.rid===rw.id)); document.getElementById('btn-claim').disabled=false; });
    grid.appendChild(d);
  });
  document.getElementById('btn-claim').disabled=true;
  document.getElementById('modal-reward').classList.add('open');
}
function claimReward(){
  if(!_rSel) return;
  const rw=REWARD_POOL.find(r=>r.id===_rSel); if(!rw) return;
  state.earnedRewards.push({level:state.level,rewardId:_rSel});
  state.pendingReward=false; save(); render();
  closeModal('modal-reward');
  toast('ğŸ‰ Reward: '+rw.icon+' '+rw.name+'!','ok',3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name,el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if(el) el.classList.add('active');
  if(name!=='scanner') stopScan();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR SCANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _scan=false,_stream=null,_loop=null,_lastQR='';

async function startScan(){
  if(_scan) return;

  // Show a status message while requesting camera
  toast('ğŸ“· Requesting camera accessâ€¦');

  try{
    // Try rear camera first (mobile), fall back to any camera (desktop)
    let stream;
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }
      });
    } catch(e){
      // Fallback: any available camera
      stream = await navigator.mediaDevices.getUserMedia({ video:true });
    }
    _stream = stream;

    const vid = document.getElementById('qr-video');
    vid.srcObject = _stream;

    // Wait for video to actually start playing before starting scan loop
    await new Promise((resolve, reject) => {
      vid.onloadedmetadata = () => {
        vid.play().then(resolve).catch(reject);
      };
      vid.onerror = reject;
      // Safety timeout
      setTimeout(resolve, 3000);
    });

    document.getElementById('video-wrap').style.display = 'block';
    document.getElementById('btn-start').style.display  = 'none';
    document.getElementById('btn-stop').style.display   = 'inline-flex';
    document.getElementById('qr-result').classList.remove('show');

    _lastQR = '';
    _scan   = true;
    _loop   = setInterval(scanFrame, 150);
    toast('ğŸ“· Camera ready â€” point at a QR code!');

  } catch(err){
    _scan = false;
    console.error('Camera error:', err);
    if(err.name === 'NotAllowedError'){
      toast('ğŸš« Camera permission denied. Please allow camera access and try again.','err',4000);
    } else if(err.name === 'NotFoundError'){
      toast('ğŸ“· No camera found on this device.','err',4000);
    } else {
      toast('ğŸ“· Camera unavailable: '+err.message,'err',4000);
    }
  }
}

function stopScan(){
  _scan = false;
  clearInterval(_loop);
  _loop = null;
  if(_stream){
    _stream.getTracks().forEach(t => t.stop());
    _stream = null;
  }
  const vid = document.getElementById('qr-video');
  if(vid) vid.srcObject = null;
  document.getElementById('video-wrap').style.display = 'none';
  document.getElementById('btn-start').style.display  = 'inline-flex';
  document.getElementById('btn-stop').style.display   = 'none';
}

function scanFrame(){
  if(!_scan) return;
  const vid = document.getElementById('qr-video');
  const cvs = document.getElementById('qr-canvas');
  if(!vid || !cvs) return;

  // Video must be playing and have valid dimensions
  if(vid.paused || vid.ended) return;
  if(vid.readyState < 2) return;  // HAVE_CURRENT_DATA or better
  if(!vid.videoWidth || !vid.videoHeight) return;

  try{
    cvs.width  = vid.videoWidth;
    cvs.height = vid.videoHeight;
    const ctx = cvs.getContext('2d');
    ctx.drawImage(vid, 0, 0, cvs.width, cvs.height);
    const imageData = ctx.getImageData(0, 0, cvs.width, cvs.height);

    if(!window.jsQR) return;

    // Use 'attemptBoth' so it detects both dark-on-light AND light-on-dark QR codes
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: 'attemptBoth'
    });

    if(code && code.data && code.data.trim() !== '' && code.data !== _lastQR){
      _lastQR = code.data;
      clearInterval(_loop);
      _loop = null;
      _scan = false;

      // Show detected result
      const display = code.data.length > 80 ? code.data.slice(0,80)+'â€¦' : code.data;
      document.getElementById('qr-result-text').textContent = display;
      document.getElementById('qr-result').classList.add('show');
      toast('âœ… QR Code detected!');
    }
  } catch(err){
    // Ignore decode errors â€” just keep scanning
  }
}

function acceptScan(){
  const raw = _lastQR;
  document.getElementById('qr-result').classList.remove('show');
  stopScan();
  let parsed=null;
  try{ parsed=JSON.parse(raw); }catch(_){}
  if(parsed&&(parsed.v===1||parsed.v===2)&&parsed.title){
    document.getElementById('qr-confirm-title').textContent=parsed.title;
    const det=document.getElementById('qr-task-details'); det.innerHTML='';
    if(parsed.notes){ const nb=document.createElement('div'); nb.className='notes-box'; nb.textContent=parsed.notes; det.appendChild(nb); }
    if(parsed.subject){ const sb=document.createElement('div'); sb.style.cssText='font-size:.76rem;color:var(--muted);margin-bottom:8px;'; sb.textContent='ğŸ“š '+parsed.subject; det.appendChild(sb); }
    if(parsed.deadline){ const db=document.createElement('div'); db.style.cssText='font-size:.76rem;color:var(--gold2);margin-bottom:8px;'; db.textContent='â° Due: '+fmtDeadline(parsed.deadline); det.appendChild(db); }
    _pendingQR=parsed;
    // Auto-set type if encoded in payload
    if(parsed.type){ _autoType=parsed.type; }
    document.getElementById('modal-qr-confirm').classList.add('open');
    // Log scan to shared storage
    recordScan(parsed);
  } else {
    // Plain text QR
    document.getElementById('qr-confirm-title').textContent=raw;
    document.getElementById('qr-task-details').innerHTML='';
    _pendingQR={title:raw};
    document.getElementById('modal-qr-confirm').classList.add('open');
  }
}
function submitManualQR(){
  const input = document.getElementById('manual-qr-input');
  const raw = (input.value || '').trim();
  if(!raw){ toast('âš  Please paste the QR code text first.','err'); return; }
  input.value = '';
  _lastQR = raw;
  // Re-use acceptScan logic
  document.getElementById('qr-result-text').textContent = raw.length>80 ? raw.slice(0,80)+'â€¦' : raw;
  acceptScan();
}

function rejectScan(){
  document.getElementById('qr-result').classList.remove('show');
  _lastQR = '';
  if(_stream && _stream.active){
    _scan = true;
    clearInterval(_loop);
    _loop = setInterval(scanFrame, 150);
    toast('ğŸ”„ Ready to scan again â€” point at QR code');
  } else {
    stopScan();
    setTimeout(startScan, 300);
  }
}

let _pendingQR=null,_autoType=null;
function addScannedTask(type){
  if(!_pendingQR) return;
  const p=_pendingQR;
  // Fetch files from teacher's tasks
  const teacherTasks=loadTeacherTasks();
  const source=teacherTasks.find(t=>t.id===p.id)||null;
  state.tasks.push({
    id:state.nextId++,
    name:p.title,
    type:type,
    subject:p.subject||'',
    notes:p.notes||'',
    deadline:p.deadline||null,
    files:source&&source.files?source.files:[],
    sourceTaskId:p.id||null,
    done:false,
    addedAt:new Date().toISOString(),
  });
  _pendingQR=null;_autoType=null;
  closeModal('modal-qr-confirm');
  save(); render();
  switchTab('tasks',document.querySelector('.tab'));
  toast('ğŸ“‹ Quest added!','ok');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCAN RECORDING (for teacher tracker)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadScans(){ try{return JSON.parse(localStorage.getItem(SCAN_KEY))||[];}catch(_){return[];} }
function loadTeacherTasks(){ try{return JSON.parse(localStorage.getItem('ql_teacher_tasks_v2'))||[];}catch(_){return[];} }

function recordScan(payload){
  if(!payload.id||!state.name) return;
  const scans=loadScans();
  // Avoid duplicate scans from same student for same task
  if(scans.some(s=>s.taskId===payload.id&&s.studentName===state.name)) return;
  const entry={
    id:'scan_'+Date.now(),
    taskId:payload.id,
    studentName:state.name,
    scannedAt:new Date().toISOString(),
    approved:false,
  };
  scans.push(entry);
  try{localStorage.setItem(SCAN_KEY,JSON.stringify(scans));}catch(_){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  render();
  if(!state.name){
    document.getElementById('modal-name').classList.add('open');
    setTimeout(()=>document.getElementById('input-name').focus(),200);
  } else {
    closeModal('modal-name');
  }
  if(state.pendingReward) setTimeout(openRewardModal,700);
  // Re-render when teacher approves (storage event from same page won't fire, but cross-tab will)
  window.addEventListener('storage',e=>{ if(e.key===SCAN_KEY||e.key==='ql_teacher_tasks_v2') render(); });
});
</script>
</body>
</html>